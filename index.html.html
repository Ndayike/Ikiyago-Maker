<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKIYAGO MAKER Office App</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF and html2pdf.js for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Google Font: Playfair Display by Claus Eggers SÃ¸rensen -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        /* General Body Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            display: flex;
            width: 95%;
            max-width: 1400px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-height: 90vh;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            position: relative; /* Needed for absolute positioning of language selector */
        }

        /* Language Selector Styling */
        .language-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1001; /* Ensure it's above other content */
            background-color: #f0f2f5;
            border-radius: 5px;
            padding: 5px 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .language-selector select {
            border: 1px solid #ccc;
            padding: 5px 8px;
            border-radius: 4px;
            background-color: #fff;
            font-size: 0.9em;
            cursor: pointer;
        }

        /* Menu Column Styles */
        .menu-column {
            width: 280px;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            box-sizing: border-box;
            flex-shrink: 0;
            border-right: 1px solid #34495e;
            display: flex;
            flex-direction: column;
        }
        
        /* --- NEW LOGO STYLES START --- */
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            height: 70px;
        }

        .book-logo {
            width: 60px;
            height: 45px;
            background-color: #345e9d; /* Blue cover/spine */
            position: relative;
            border-radius: 4px 2px 2px 4px;
            transform: perspective(1000px) rotateY(15deg);
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        }

        .book-logo::before, .book-logo::after {
            content: '';
            position: absolute;
            background-color: #ffffff; /* White pages */
            border: 1px solid #ddd;
        }
        
        .book-logo::before { /* Left Page */
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-origin: left center;
            transform: rotateY(25deg);
            border-radius: 4px 2px 2px 4px;
            background-image: 
                linear-gradient(to bottom, #CD2A3E 20%, #CD2A3E 35%, transparent 35%),
                linear-gradient(to bottom, transparent 45%, #CD2A3E 45%, #CD2A3E 60%, transparent 60%);
        }

        .book-logo::after { /* Right Page */
            width: 100%;
            height: 100%;
            top: 0;
            right: 0;
            transform-origin: right center;
            transform: rotateY(-25deg);
            border-radius: 2px 4px 4px 2px;
             background-image: 
                linear-gradient(to bottom, #CD2A3E 20%, #CD2A3E 45%, transparent 45%),
                linear-gradient(to bottom, transparent 55%, #CD2A3E 55%, #CD2A3E 70%, transparent 70%);
        }
        /* --- NEW LOGO STYLES END --- */


        .menu-column h1 {
            text-align: center;
            color: #ecf0f1;
            margin-top: 0;
            margin-bottom: 10px; /* Reduced margin */
            font-size: 1.8em; /* Adjusted size */
            font-weight: 600;
        }
        
        .title-divider {
            width: 60%;
            margin: 0 auto 10px auto;
            border: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }

        .designer-credit {
            color: yellow;
            text-align: center;
            font-size: 0.8em;
            margin-top: 0;
            margin-bottom: 30px; /* Space before menu items */
            font-family: 'Playfair Display', serif; /* Applied Playfair Display font */
        }

        /* New Menu Footer Styling */
        .menu-footer-info {
            background-color: #27ae60; /* Green container */
            color: #ffffff; /* White characters */
            padding: 15px;
            margin-top: auto; /* Pushes content to the bottom of the flex container */
            border-radius: 8px;
            font-family: 'Playfair Display', serif; /* Playfair Display font */
            font-style: italic; /* Italic font */
            font-size: 0.9em;
            line-height: 1.4;
            text-align: justify;
        }


        .menu-column nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-column nav ul li {
            margin-bottom: 10px;
        }

        .menu-column nav ul li button {
            width: 100%;
            padding: 14px 20px;
            background-color: #34495e;
            color: #ecf0f1;
            border: none;
            border-radius: 6px;
            text-align: left;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
        }

        .menu-column nav ul li button:hover {
            background-color: #4a667f;
            transform: translateX(3px);
        }

        .menu-column nav ul li button.active {
            background-color: #1abc9c;
            font-weight: bold;
        }
        
        .menu-column nav ul li button i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .menu-column nav ul li.separator {
            border-top: 1px solid #4a667f;
            margin: 25px 0;
        }

        /* Main Content Area Styles */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: auto;
            max-height: 90vh;
            box-sizing: border-box;
            background-color: #e0e6ed; /* Contrasting background for pages */
        }

        .main-content h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e6ed;
            padding-bottom: 10px;
            font-size: 1.8em;
            font-weight: 600;
        }

        /* Section Specific Styles */
        .book-section {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #cfd8e3;
        }
        .book-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Cover Page Styles */
        .cover-page {
            text-align: center;
            padding: 20px 0;
            background-color: #fdfefe;
            border: 1px dashed #dbe3ed;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .cover-page h2 {
            font-size: 2.2em;
            margin-bottom: 15px;
            border-bottom: none;
            padding-bottom: 0;
            color: #34495e;
        }

        .cover-page label {
            display: block;
            margin-top: 15px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        .cover-page input[type="file"] {
            display: block;
            margin: 0 auto 20px auto;
            border: 1px solid #c0d0e0;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            width: 70%;
            max-width: 400px;
        }

        /* Front & Back Cover Specific Styles */
        .cover-design-area {
            position: relative;
            width: 210mm;
            height: 287mm;
            margin: 15px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #f0f0f0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: #aaa;
        }

        .cover-design-area .cover-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .cover-design-area .cover-preview[src="#"] {
            display: none;
        }

        .book-number-container {
            position: absolute;
            bottom: 1in;
            right: 1in;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 2;
            min-width: 120px;
        }

        .book-number-container input[type="text"] {
            width: 100%;
            padding: 5px;
            border: none;
            background-color: transparent;
            font-size: 1em;
            color: #333;
            text-align: center;
            font-weight: bold;
        }
        .book-number-container label {
            display: block;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
            font-weight: normal;
        }

        /* Page Header and Footer Styles */
        .page-header-footer {
            padding-bottom: 5px;
            transition: all 0.3s ease;
        }
        .header-input, .section-footer-input {
            width: 90%;
            border: none;
            font-size: 0.95em;
            text-align: center;
            color: #6c7a89;
            padding: 5px;
            background-color: transparent;
            border-bottom: 1px dashed #ccc;
            margin: 0 auto 5px auto;
            display: block;
            transition: all 0.3s ease;
        }
        .page-header-footer.is-empty {
            padding-bottom: 0;
        }
        .page-header-footer.is-empty .header-input,
        .page-header-footer.is-empty .section-footer-input {
            margin-bottom: 0;
            border-color: transparent;
        }
        
        .page-wrapper .page-footer-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end; /* Pushes content to the right */
            align-items: center;
            border-top: 1px solid #e0e6ed;
            padding-top: 10px;
            margin-top: 20px;
            gap: 15px;
        }
        
        .page-number-container {
            position: relative;
            background-color: #27ae60; /* GREEN */
            color: white;
            padding: 4px 10px;
            padding-right: 22px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            flex-shrink: 0;
            transition: opacity 0.3s ease;
            bottom: 22px; /* Lift page number container upward by 22px */
        }
        .page-number-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .remove-page-number {
            position: absolute;
            top: -2px;
            right: 4px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            color: #fff;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .remove-page-number:hover {
            opacity: 1;
        }
        
        .page-controls-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .remove-page-btn {
            background: none;
            border: none;
            color: #c0392b;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .remove-page-btn:hover {
            color: #fff;
            background-color: #e74c3c;
        }


        .page-numbering-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #555;
            padding: 5px;
            border: 1px solid #e0e6ed;
            border-radius: 5px;
        }
        .page-numbering-controls label {
            cursor: pointer;
        }
        .page-start-input {
            width: 50px;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .page-start-input:disabled {
            background-color: #f1f1f1;
            cursor: not-allowed;
        }

        .title-section {
            padding: 15px;
            border-bottom: 1px solid #dbe3ed;
        }
        
        .main-title-container {
            background-color: #009E60;
            padding: 15px 20px;
            padding-bottom: 25px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.3s ease;
        }
        .main-title-container.is-empty {
            padding-top: 5px;
            padding-bottom: 10px;
            margin-bottom: 5px;
            min-height: 25px;
        }

        .main-title-container::before,
        .main-title-container::after {
            content: '';
            position: absolute;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .main-title-container::before {
            background-color: #F4F5F0;
            bottom: 4px;
        }

        .main-title-container::after {
            background-color: #CD212A;
            bottom: 0;
        }

        .title-section .main-title {
            width: 100%;
            display: block;
            border: none;
            padding: 8px;
            background-color: transparent;
            text-align: center;
            box-sizing: border-box;
            font-size: 2.2em;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.3;
        }
        
        .subtitle-container {
            padding: 10px 0;
            transition: padding 0.3s ease;
        }
        .subtitle-container.is-empty {
            padding: 0;
        }

        .title-section .subtitle {
            width: 100%;
            display: inline-block;
            border: none;
            border-bottom: 3px solid #c0392b;
            padding: 8px;
            padding-bottom: 5px;
            background-color: transparent;
            text-align: center;
            box-sizing: border-box;
            font-size: 1.1em;
            font-weight: bold;
            color: #c0392b;
            transition: border-color 0.3s ease;
        }
        .subtitle-container.is-empty .subtitle {
            border-bottom-color: transparent;
        }

        .rich-text-editor-container {
            border: 1px solid #dbe3ed;
            border-radius: 4px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .editor-toolbar {
            background-color: #e0e6ed;
            padding: 8px 10px;
            border-bottom: 1px solid #dbe3ed;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .editor-toolbar button {
            background-color: #f0f2f5;
            border: 1px solid #c0d0e0;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            color: #333;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .editor-toolbar button:hover {
            background-color: #d8e0e9;
            border-color: #aebecf;
        }
        .editor-toolbar button.active {
            background-color: #aebecf;
            border-color: #8fa1b8;
            color: #2c3e50;
        }
        .editor-toolbar input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 30px; height: 30px; border: none; background: none; cursor: pointer;
            padding: 0; margin-left: 10px; vertical-align: middle;
        }
        .editor-toolbar input[type="color"]::-webkit-color-swatch {
            border-radius: 3px; border: 1px solid #c0d0e0;
        }
        .editor-toolbar input[type="color"]::-moz-color-swatch {
            border-radius: 3px; border: 1px solid #c0d0e0;
        }

        .editor-toolbar select {
            padding: 6px; border: 1px solid #c0d0e0; border-radius: 3px;
            background-color: #f0f2f5; color: #333; cursor: pointer; font-size: 0.9em;
        }
        .editor-toolbar select:hover {
            background-color: #d8e0e9; border-color: #aebecf;
        }

        .master-text-editor {
            width: 210mm;
            height: 287mm;
            padding: 1in;
            box-sizing: border-box;
            background-color: #fff;
            outline: none;
            overflow-y: hidden;
            margin: 15px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            font-family: 'Times New Roman', Times, serif; /* Default font */
        }
        
        .master-text-editor[data-placeholder-visible="true"]::before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
            position: absolute;
            top: 1in;
            left: 1in;
            pointer-events: none;
            display: block;
        }
        
        .page-wrapper {
            position: relative;
            margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #aebecf;
        }
        .page-wrapper:last-child {
            border-bottom: none; margin-bottom: 0; padding-bottom: 0;
        }

        .limit-indicator {
            position: absolute;
            bottom: calc(1in + 45px);
            left: 5%;
            width: 90%;
            background-color: rgba(211, 84, 0, 0.8);
            color: white;
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 10;
            display: none;
            pointer-events: none;
        }


        .add-page-button-container {
            text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 15px;
        }

        .add-page-btn {
            background-color: #27ae60; color: white; border: none; padding: 12px 25px;
            border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .add-page-btn:hover {
            background-color: #229954;
        }
        .add-page-btn i {
            margin-right: 8px;
        }
        
        .design-page-btn {
            background-color: #3498db;
        }
        .design-page-btn:hover {
            background-color: #2980b9;
        }

        /* Styles for inserted images to be inline, resizable */
        .image-with-caption {
            display: inline-block; /* Inline object */
            vertical-align: middle; /* Align with text baseline */
            margin: 0 0.5em; /* Small horizontal margin to separate from text */
            max-width: 100%; /* Ensure it doesn't exceed editor width */
            width: auto; /* Allow auto width or specific inline width from resizable container */
        }

        .resizable-image-container {
            position: relative;
            display: inline-block; /* Essential for text-align: center on parent and for float behavior */
            resize: both; /* Enable resizing */
            overflow: auto; /* To show resize handles */
            min-width: 50px;
            min-height: 50px;
            border: 1px dashed transparent; /* Visual border for resizing */
            box-sizing: border-box; /* Include padding/border in width/height */
            cursor: nwse-resize; /* Resizing cursor */
        }
        .resizable-image-container:hover {
            border-color: #c0d0e0;
        }
        .resizable-image-container img {
            display: block;
            width: 100%; /* Image fills its resizable container */
            height: 100%;
            object-fit: contain; /* Ensure image fits without cropping */
        }

        .image-with-caption figcaption {
            font-size: 0.9em; font-style: italic; color: #555;
            padding: 8px; outline: none; background-color: #f9f9f9;
            border-radius: 0 0 4px 4px; margin-top: -1px;
            text-align: center;
            display: block; /* Caption is block within the inline-block figure */
        }

        .image-with-caption figcaption:empty::before {
            content: attr(data-placeholder); color: #999;
        }
        
        .master-text-editor .custom-quote {
            position: relative;
            padding-left: 25px;
            margin: 1em 0;
            font-style: italic;
            border: none;
            background-color: #f9f9f9;
            padding-top: 10px;
            padding-bottom: 10px;
            padding-right: 10px;
            border-radius: 4px;
        }

        .master-text-editor .custom-quote::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            bottom: 5px;
            width: 9px;
            background: linear-gradient(to right, 
                #CD2A3E 33.3%, 
                #F4F5F0 33.3%, #F4F5F0 66.6%, 
                #008C45 66.6%
            );
            border-radius: 5px;
        }
        
        .design-page-container {
            width: 210mm;
            height: 287mm;
            margin: 15px auto;
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .design-page-container .design-preview-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none; /* Hidden by default */
        }
        
        .design-page-container .upload-prompt {
            text-align: center;
            color: #888;
        }
        
        .design-page-container .upload-prompt i {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .custom-context-menu {
            position: absolute; z-index: 1000; background-color: #ffffff;
            border: 1px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-radius: 5px; padding: 5px 0; display: none; font-size: 0.9em;
        }
        .custom-context-menu ul {
            list-style: none; padding: 0; margin: 0;
        }
        .custom-context-menu ul li {
            padding: 8px 15px; cursor: pointer;
        }
        .custom-context-menu ul li i {
            margin-right: 8px; width: 16px; text-align: center;
        }
        .custom-context-menu ul li:hover {
            background-color: #f0f2f5;
        }
        .custom-context-menu .separator {
            height: 1px; background-color: #eee; margin: 5px 0; padding: 0;
        }
        
        @media (max-width: 1024px) {
            .app-container { width: 98%; margin: 10px 0; min-height: 95vh; }
            .menu-column { width: 220px; padding: 20px; }
            .menu-column h1 { font-size: 1.6em; }
            .menu-column nav ul li button { font-size: 1em; padding: 12px 15px; }
            .main-content { padding: 20px; }
            .main-content h2 { font-size: 1.6em; }
            .book-number-container { padding: 8px 12px; bottom: 10px; right: 10px; min-width: 100px; }
            .editor-toolbar button, .editor-toolbar select { font-size: 0.8em; padding: 5px 8px; }
            .editor-toolbar input[type="color"] { width: 25px; height: 25px; }
        }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; width: 100%; margin: 0; min-height: auto; border-radius: 0; box-shadow: none; }
            .language-selector { top: 10px; right: 10px; padding: 3px 8px; }
            .language-selector select { font-size: 0.8em; padding: 4px 6px; }
            .menu-column { width: 100%; padding: 15px; border-right: none; border-bottom: 1px solid #34495e; }
            .menu-column h1 { margin-bottom: 20px; }
            .menu-column nav ul { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
            .menu-column nav ul li { width: calc(50% - 5px); margin-bottom: 0; }
            .menu-column nav ul li button { text-align: center; font-size: 0.9em; padding: 10px; }
            .menu-column nav ul li.separator { width: 100%; margin: 15px 0; }
            .main-content { padding: 15px; max-height: none; }
            .cover-page, .book-section { padding: 15px 0; margin-bottom: 20px; }
            .title-section .main-title { font-size: 1.8em; }
            .title-section .subtitle { font-size: 1em; }
            .book-number-container { padding: 5px 8px; bottom: 8px; right: 8px; min-width: 90px; }
            .editor-toolbar { flex-direction: row; justify-content: center; gap: 3px; }
            .editor-toolbar button, .editor-toolbar select { font-size: 0.7em; padding: 4px 6px; min-width: unset; flex-grow: 1; }
            .editor-toolbar input[type="color"] { width: 20px; height: 20px; margin-left: 5px; }
        }

        @media print {
            body { background-color: #fff; }
            .menu-column, .add-page-button-container, .page-footer-container, .header-controls, .language-selector {
                display: none;
            }
            .app-container, .main-content {
                width: 100%;
                max-width: 100%;
                padding: 0;
                margin: 0;
                box-shadow: none;
            }
            .book-section {
                border: none;
            }
            .page-wrapper {
                page-break-after: always;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Language Selector -->
        <div class="language-selector">
            <select id="language-switcher">
                <option value="en">English</option>
                <option value="fr">FranÃ§ais</option>
                <option value="pt">PortuguÃªs</option>
            </select>
        </div>

        <!-- Menu Column -->
        <aside class="menu-column">
             <div class="logo-container">
                <div class="book-logo"></div>
            </div>
            <h1>IKIYAGO MAKER</h1>
            <hr class="title-divider">
            <p class="designer-credit" data-i18n="developedBy">Developed by Ndayikeze Apollinaire</p>
            <nav>
                <ul>
                    <li><button id="showFrontCoverBtn" onclick="showSection('front-cover', this)" data-i18n="frontCoverBtn"><i class="fas fa-book-open"></i>Front Cover</button></li>
                    <li><button id="showKirundiBtn" onclick="showSection('kirundi', this)" data-i18n="kirundiSectionBtn"><i class="fas fa-file-alt"></i>Kirundi Section</button></li>
                    <li><button id="showFrenchBtn" onclick="showSection('french', this)" data-i18n="frenchSectionBtn"><i class="fas fa-file-alt"></i>French Section</button></li>
                    <li><button id="showEnglishBtn" onclick="showSection('english', this)" data-i18n="englishSectionBtn"><i class="fas fa-file-alt"></i>English Section</button></li>
                    <li><button id="showBackCoverBtn" onclick="showSection('back-cover', this)" data-i18n="backCoverBtn"><i class="fas fa-book"></i>Back Cover</button></li>
                    <li class="separator"></li>
                    <li><button id="openProjectBtn" onclick="openProject()" data-i18n="openProjectBtn"><i class="fas fa-folder-open"></i> Open Project</button></li>
                    <li><button id="saveProjectBtn" onclick="saveProject()" data-i18n="saveProjectBtn"><i class="fas fa-save"></i> Save Project</button></li>
                    <li class="separator"></li>
                    <li><button id="previewBookBtn" onclick="previewBook()" data-i18n="previewBookBtn"><i class="fas fa-eye"></i> Preview Book</button></li>
                    <li><button id="exportPdf" onclick="exportToPdf()" data-i18n="exportPdf"><i class="fas fa-file-pdf"></i> Export to PDF</button></li>
                    <li><button id="exportDocx" onclick="promptAndSaveAsDocx()" data-i18n="exportDocx"><i class="fas fa-file-word"></i> Save as Word (Docx)</button></li>
                </ul>
            </nav>

            <div class="menu-footer-info" data-i18n="footerInfo">
                Ndayikeze Apollinaire is a Visual Communication Expert, Author and a relentless IT researcher whose work in automation bridges technical precision with visionary purpose. With a deep commitment to streamlining digital workflows and enhancing platform responsiveness, he continuously explores innovative solutions that empower editorial systems, multilingual interfaces, and institutional communication. His research is not confined to theoryâitâs embedded in real-world applications across the world where automation becomes a tool for dignity, clarity and societal transformation.
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Front Cover Section -->
            <section id="front-cover-section" class="book-section cover-page" style="display: none;">
                <h2 data-i18n="frontCoverSectionTitle">Front Cover</h2>
                <div class="cover-content">
                    <label for="frontCoverImage" data-i18n="uploadFrontCoverImage">Upload Front Cover Image:</label>
                    <input type="file" id="frontCoverImage" accept="image/png, image/jpeg">

                    <div class="cover-design-area">
                        <span id="coverPlaceholder" style="color: #aaa; font-style: italic;" data-i18n="coverPlaceholder">Upload Front Cover Image</span>
                        <img id="frontCoverPreview" src="#" alt="Front Cover Preview" class="cover-preview" style="display:none;">
                        <div class="book-number-container">
                            <label for="bookNumber" data-i18n="bookNumberLabel">Book Number:</label>
                            <input type="text" id="bookNumber" data-i18n-placeholder="bookNumberPlaceholder" placeholder="Enter #">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Kirundi Section -->
            <section id="kirundi-section" class="book-section" data-section-lang="kirundi" style="display: block;">
                <div class="header-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 data-i18n="kirundiSectionTitle">Kirundi Section</h2>
                    <div class="page-numbering-controls">
                        <label data-i18n="numberingLabel"><b>Numbering:</b></label>
                        <input type="radio" id="continue-kirundi" name="numbering-kirundi" value="continue"> <label for="continue-kirundi" data-i18n="numberingContinue">Continue</label>
                        <input type="radio" id="start-new-kirundi" name="numbering-kirundi" value="start_new" checked> <label for="start-new-kirundi" data-i18n="numberingStartNew">Start New</label>
                        <input type="radio" id="start-from-kirundi" name="numbering-kirundi" value="start_from"> <label for="start-from-kirundi" data-i18n="numberingStartAt">Start at:</label>
                        <input type="number" class="page-start-input" id="start-input-kirundi" value="1" min="1">
                    </div>
                </div>
                <div class="page-header-footer">
                     <input type="text" class="header-input" data-i18n-placeholder="kirundiHeaderPlaceholder" placeholder="Kirundi Header (applies to all pages in this section)">
                     <input type="text" class="section-footer-input" data-i18n-placeholder="kirundiFooterPlaceholder" placeholder="Kirundi Footer (applies to all pages in this section)">
                </div>
                <div class="pages-container" id="pages-container-kirundi">
                </div>
                <div class="add-page-button-container">
                    <button class="add-page-btn" onclick="addPage('kirundi', 'text')" data-i18n="addPage"><i class="fas fa-plus-circle"></i> Add New Page</button>
                    <button class="add-page-btn design-page-btn" onclick="addPage('kirundi', 'design')" data-i18n="addDesign"><i class="fas fa-image"></i> Add a Design</button>
                </div>
            </section>

            <!-- French Section -->
            <section id="french-section" class="book-section" data-section-lang="french" style="display: none;">
                <div class="header-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 data-i18n="frenchSectionTitle">French Section</h2>
                     <div class="page-numbering-controls">
                        <label data-i18n="numberingLabel"><b>Numbering:</b></label>
                        <input type="radio" id="continue-french" name="numbering-french" value="continue"> <label for="continue-french" data-i18n="numberingContinue">Continue</label>
                        <input type="radio" id="start-new-french" name="numbering-french" value="start_new" checked> <label for="start-new-french" data-i18n="numberingStartNew">Start New</label>
                        <input type="radio" id="start-from-french" name="numbering-french" value="start_from"> <label for="start-from-french" data-i18n="numberingStartAt">Start at:</label>
                        <input type="number" class="page-start-input" id="start-input-french" value="1" min="1">
                    </div>
                </div>
                 <div class="page-header-footer">
                     <input type="text" class="header-input" data-i18n-placeholder="frenchHeaderPlaceholder" placeholder="French Header (applies to all pages in this section)">
                     <input type="text" class="section-footer-input" data-i18n-placeholder="frenchFooterPlaceholder" placeholder="French Footer (aplies to all pages in this section)">
                </div>
                <div class="pages-container" id="pages-container-french">
                </div>
                 <div class="add-page-button-container">
                    <button class="add-page-btn" onclick="addPage('french', 'text')" data-i18n="addPage"><i class="fas fa-plus-circle"></i> Add New Page</button>
                    <button class="add-page-btn design-page-btn" onclick="addPage('french', 'design')" data-i18n="addDesign"><i class="fas fa-image"></i> Add a Design</button>
                </div>
            </section>

            <!-- English Section -->
            <section id="english-section" class="book-section" data-section-lang="english" style="display: none;">
                 <div class="header-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 data-i18n="englishSectionTitle">English Section</h2>
                    <div class="page-numbering-controls">
                        <label data-i18n="numberingLabel"><b>Numbering:</b></label>
                        <input type="radio" id="continue-english" name="numbering-english" value="continue"> <label for="continue-english" data-i18n="numberingContinue">Continue</label>
                        <input type="radio" id="start-new-english" name="numbering-english" value="start_new" checked> <label for="start-new-english" data-i18n="numberingStartNew">Start New</label>
                        <input type="radio" id="start-from-english" name="numbering-english" value="start_from"> <label for="start-from-english" data-i18n="numberingStartAt">Start at:</label>
                        <input type="number" class="page-start-input" id="start-input-english" value="1" min="1">
                    </div>
                </div>
                 <div class="page-header-footer">
                     <input type="text" class="header-input" data-i18n-placeholder="englishHeaderPlaceholder" placeholder="English Header (applies to all pages in this section)">
                     <input type="text" class="section-footer-input" data-i18n-placeholder="englishFooterPlaceholder" placeholder="English Footer (aplies to all pages in this section)">
                </div>
                <div class="pages-container" id="pages-container-english">
                </div>
                 <div class="add-page-button-container">
                    <button class="add-page-btn" onclick="addPage('english', 'text')" data-i18n="addPage"><i class="fas fa-plus-circle"></i> Add New Page</button>
                    <button class="add-page-btn design-page-btn" onclick="addPage('english', 'design')" data-i18n="addDesign"><i class="fas fa-image"></i> Add a Design</button>
                </div>
            </section>

            <!-- Back Cover Section -->
            <section id="back-cover-section" class="book-section cover-page" style="display: none;">
                <h2 data-i18n="backCoverSectionTitle">Back Cover</h2>
                <div class="cover-content">
                    <label for="backCoverImage" data-i18n="uploadBackCoverImage">Upload Back Cover Image:</label>
                    <input type="file" id="backCoverImage" accept="image/png, image/jpeg">
                    <div class="cover-design-area">
                        <span id="backCoverPlaceholder" style="color: #aaa; font-style: italic;" data-i18n="backCoverPlaceholder">Upload Back Cover Image</span>
                        <img id="backCoverPreview" src="#" alt="Back Cover Preview" class="cover-preview" style="display:none;">
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Hidden file input for image insertion -->
    <input type="file" id="image-inserter" accept="image/*" style="display:none;">
    <input type="file" id="project-opener" accept=".json" style="display:none;">

    <!-- Custom Context Menus -->
    <div id="text-context-menu" class="custom-context-menu">
        <ul>
            <li id="insert-image-option" data-i18n="insertImage"><i class="fas fa-image"></i> Insert Image</li>
        </ul>
    </div>
    <div id="image-context-menu" class="custom-context-menu">
        <ul>
            <li id="float-left-option" data-i18n="floatLeft"><i class="fas fa-align-left"></i> Float Left</li>
            <li id="float-right-option" data-i18n="floatRight"><i class="fas fa-align-right"></i> Float Right</li>
            <li id="no-float-option" data-i18n="noFloat"><i class="fas fa-grip-lines"></i> No Float</li>
            <li class="separator"></li>
            <li id="align-left-option" data-i18n="alignLeftNoFloat"><i class="fas fa-align-left"></i> Align Left (no float)</li>
            <li id="align-center-option" data-i18n="alignCenterNoFloat"><i class="fas fa-align-center"></i> Align Center (no float)</li>
            <li id="align-right-option" data-i18n="alignRightNoFloat"><i class="fas fa-align-right"></i> Align Right (no float)</li>
            <li class="separator"></li>
            <li id="replace-image-option" data-i18n="replaceImage"><i class="fas fa-sync-alt"></i> Replace Image</li>
            <li id="remove-image-option" data-i18n="removeImage"><i class="fas fa-trash-alt"></i> Remove Image</li>
        </ul>
    </div>


    <script>
        const SECTION_ORDER = ['kirundi', 'french', 'english'];
        let currentLanguage = 'en'; // Default language
        
        const translations = {
            en: {
                // Menu
                frontCoverBtn: "Front Cover",
                kirundiSectionBtn: "Kirundi Section",
                frenchSectionBtn: "French Section",
                englishSectionBtn: "English Section",
                backCoverBtn: "Back Cover",
                openProjectBtn: "Open Project",
                saveProjectBtn: "Save Project",
                previewBookBtn: "Preview Book",
                exportPdf: "Export to PDF",
                exportDocx: "Save as Word (Docx)",
                developedBy: "Developed by Ndayikeze Apollinaire",
                footerInfo: "Ndayikeze Apollinaire is a Visual Communication Expert, Author and a relentless IT researcher whose work in automation bridges technical precision with visionary purpose. With a deep commitment to streamlining digital workflows and enhancing platform responsiveness, he continuously explores innovative solutions that empower editorial systems, multilingual interfaces, and institutional communication. His research is not confined to theoryâitâs embedded in real-world applications across the world where automation becomes a tool for dignity, clarity and societal transformation.",

                // Section Titles
                frontCoverSectionTitle: "Front Cover",
                kirundiSectionTitle: "Kirundi Section",
                frenchSectionTitle: "French Section",
                englishSectionTitle: "English Section",
                backCoverSectionTitle: "Back Cover",

                // Placeholders and Labels
                uploadFrontCoverImage: "Upload Front Cover Image:",
                coverPlaceholder: "Upload Front Cover Image",
                bookNumberLabel: "Book Number:",
                bookNumberPlaceholder: "Enter #",
                kirundiHeaderPlaceholder: "Kirundi Header (applies to all pages in this section)",
                kirundiFooterPlaceholder: "Kirundi Footer (applies to all pages in this section)",
                frenchHeaderPlaceholder: "French Header (aplies to all pages in this section)",
                frenchFooterPlaceholder: "French Footer (applies to all pages in this section)",
                englishHeaderPlaceholder: "English Header (applies to all pages in this section)",
                englishFooterPlaceholder: "English Footer (aplies to all pages in this section)",
                mainTitlePlaceholder: (lang, pageNum) => `Main Title (${lang} - Page ${pageNum})`, // dynamic
                subtitlePlaceholder: (lang, pageNum) => `Optional Subtitle (${lang} - Page ${pageNum})`, // dynamic
                editorPlaceholder: (pageNum) => `Start typing on page ${pageNum}...`, // dynamic
                captionPlaceholder: "Enter caption here...",
                uploadDesignPrompt: "Click or drag file to this area to upload",
                uploadBackCoverImage: "Upload Back Cover Image:",
                backCoverPlaceholder: "Upload Back Cover Image",
                
                // Toolbar
                undo: "Undo", redo: "Redo", quote: "Quote", bold: "Bold", italic: "Italic", underline: "Underline",
                bulletList: "Bulleted List", numberedList: "Numbered List", indent: "Indent", outdent: "Outdent",
                copy: "Copy", cut: "Cut", paste: "Paste", delete: "Delete", selectAll: "Select All",
                fontSize: "Size", font: "Font", textColor: "Text Color",
                alignLeft: "Align Left", alignCenter: "Align Center", alignRight: "Align Right", justify: "Justify",
                twoColumns: "2 Columns", threeColumns: "3 Columns", oneColumn: "1 Column (Remove Columns)",

                // Page Controls
                addPage: "Add New Page",
                addDesign: "Add a Design",
                removePageTitle: "Remove this page",
                hidePageNumberTitle: "Hide page number",

                // System messages
                alertSelectTextForColumns: "Please select the text you want to format into columns.",
                alertAllowPopups: "Please allow pop-ups for this site to see the preview.",
                alertCouldNotExportPdf: "Could not export to PDF. Please open the preview from the main editor.",
                alertCouldNotExportWord: "Could not export to Word. Please open the preview from the main editor.",
                alertMainEditorUrlCopied: "Main editor URL copied to clipboard! The preview content is dynamic and not directly addressable by a persistent URL.",
                alertFailedToCopyUrl: "Failed to copy URL.",
                confirmRemovePage: "Are you sure you want to remove this page and all its content?",
                alertCannotDeleteLastTextPage: "You cannot delete the only text page in a section. Add another page first if you wish to replace it.",
                alertErrorOpeningProject: "Error: Could not open or parse the project file.",
                alertProjectLoaded: "Project loaded successfully!",
                promptEnterFilenameJson: "Enter filename for project (e.g., my-project.json):",
                promptEnterFilenameDoc: "Enter filename for Word document (e.g., my-book.doc):",
                limitReached: "LIMIT REACHED",
                autoSaveMessage: "Project auto-saved!",
                loadAutoSavePrompt: "An auto-saved project was found. Do you want to load it?",


                // Page Numbering Controls
                numberingLabel: "Numbering:",
                numberingContinue: "Continue",
                numberingStartNew: "Start New",
                numberingStartAt: "Start at:",

                // Context Menu
                insertImage: "Insert Image",
                floatLeft: "Float Left",
                floatRight: "Float Right",
                noFloat: "No Float",
                alignLeftNoFloat: "Align Left (no float)",
                alignCenterNoFloat: "Align Center (no float)",
                alignRightNoFloat: "Align Right (no float)",
                replaceImage: "Replace Image",
                removeImage: "Remove Image",
                saveAsPdf: "Save as PDF",
                saveAsWord: "Save as Word",
                copyUrl: "Copy URL"
            },
            fr: {
                // Menu
                frontCoverBtn: "Couverture Avant",
                kirundiSectionBtn: "Section Kirundi",
                frenchSectionBtn: "Section FranÃ§aise",
                englishSectionBtn: "Section Anglaise",
                backCoverBtn: "Couverture ArriÃ¨re",
                openProjectBtn: "Ouvrir Projet",
                saveProjectBtn: "Enregistrer Projet",
                previewBookBtn: "AperÃ§u du Livre",
                exportPdf: "Exporter en PDF",
                exportDocx: "Enregistrer au format Word (Docx)",
                developedBy: "DÃ©veloppÃ© par Ndayikeze Apollinaire",
                footerInfo: "Ndayikeze Apollinaire est un expert en communication visuelle, auteur et un chercheur IT implacable dont le travail en automatisation jette un pont entre la prÃ©cision technique et un objectif visionnaire. Avec un engagement profond Ã  rationaliser les flux de travail numÃ©riques et Ã  amÃ©liorer la rÃ©activitÃ© des plateformes, il explore continuellement des solutions innovantes qui renforcent les systÃ¨mes Ã©ditoriaux, les interfaces multilingues et la communication institutionnelle. Ses recherches ne se limitent pas Ã  la thÃ©orieâelles sont ancrÃ©es dans des applications concrÃ¨tes Ã  travers le monde oÃ¹ l'automatisation devient un outil de dignitÃ©, de clartÃ© et de transformation sociÃ©tale.",

                // Section Titles
                frontCoverSectionTitle: "Couverture Avant",
                kirundiSectionTitle: "Section Kirundi",
                frenchSectionTitle: "Section FranÃ§aise",
                englishSectionTitle: "Section Anglaise",
                backCoverSectionTitle: "Couverture ArriÃ¨re",

                // Placeholders and Labels
                uploadFrontCoverImage: "TÃ©lÃ©charger l'image de couverture avant :",
                coverPlaceholder: "TÃ©lÃ©charger l'image de couverture avant",
                bookNumberLabel: "NumÃ©ro de livre :",
                bookNumberPlaceholder: "Entrer #",
                kirundiHeaderPlaceholder: "En-tÃªte Kirundi (s'applique Ã  toutes les pages de cette section)",
                kirundiFooterPlaceholder: "Pied de page Kirundi (s'applique Ã  toutes les pages de cette section)",
                frenchHeaderPlaceholder: "En-tÃªte FranÃ§ais (s'applique Ã  toutes les pages de cette section)",
                frenchFooterPlaceholder: "Pied de page FranÃ§ais (s'applique Ã  toutes les pages de cette section)",
                englishHeaderPlaceholder: "En-tÃªte Anglais (s'applique Ã  toutes les pages de cette section)",
                englishFooterPlaceholder: "Pied de page Anglais (s'applique Ã  toutes les pages de cette section)",
                mainTitlePlaceholder: (lang, pageNum) => `Titre Principal (${lang} - Page ${pageNum})`, // dynamic
                subtitlePlaceholder: (lang, pageNum) => `Sous-titre Optionnel (${lang} - Page ${pageNum})`, // dynamic
                editorPlaceholder: (pageNum) => `Commencez Ã  taper sur la page ${pageNum}...`, // dynamic
                captionPlaceholder: "Entrez la lÃ©gende ici...",
                uploadDesignPrompt: "Cliquez ou glissez le fichier ici pour tÃ©lÃ©charger",
                uploadBackCoverImage: "TÃ©lÃ©charger l'image de couverture arriÃ¨re :",
                backCoverPlaceholder: "TÃ©lÃ©charger l'image de couverture arriÃ¨re",

                // Toolbar
                undo: "Annuler", redo: "RÃ©tablir", quote: "Citation", bold: "Gras", italic: "Italique", underline: "Souligner",
                bulletList: "Liste Ã  puces", numberedList: "Liste numÃ©rotÃ©e", indent: "Indenter", outdent: "DÃ©sindenter",
                copy: "Copier", cut: "Couper", paste: "Coller", delete: "Supprimer", selectAll: "Tout sÃ©lectionner",
                fontSize: "Taille", font: "Police", textColor: "Couleur Texte",
                alignLeft: "Aligner Ã  gauche", alignCenter: "Centrer", alignRight: "Aligner Ã  droite", justify: "Justifier",
                twoColumns: "2 Colonnes", threeColumns: "3 Colonnes", oneColumn: "1 Colonne (Supprimer Colonnes)",

                // Page Controls
                addPage: "Ajouter Nouvelle Page",
                addDesign: "Ajouter un Design",
                removePageTitle: "Supprimer cette page",
                hidePageNumberTitle: "Masquer le numÃ©ro de page",

                // System messages
                alertSelectTextForColumns: "Veuillez sÃ©lectionner le texte que vous souhaitez formater en colonnes.",
                alertAllowPopups: "Veuillez autoriser les fenÃªtres contextuelles pour ce site pour voir l'aperÃ§u.",
                alertCouldNotExportPdf: "Impossible d'exporter en PDF. Veuillez ouvrir l'aperÃ§u depuis l'Ã©diteur principal.",
                alertCouldNotExportWord: "Impossible d'exporter en Word. Veuillez ouvrir l'aperÃ§u depuis l'Ã©diteur principal.",
                alertMainEditorUrlCopied: "L'URL de l'Ã©diteur principal a Ã©tÃ© copiÃ©e dans le presse-papiers ! Le contenu de l'aperÃ§u est dynamique et non directement adressable par une URL persistante.",
                alertFailedToCopyUrl: "Ãchec de la copie de l'URL.",
                confirmRemovePage: "Ãtes-vous sÃ»r de vouloir supprimer cette page et tout son contenu ?",
                alertCannotDeleteLastTextPage: "Vous ne pouvez pas supprimer la seule page de texte d'une section. Ajoutez une autre page d'abord si vous souhaitez la remplacer.",
                alertErrorOpeningProject: "Erreur : Impossible d'ouvrir ou d'analyser le fichier projet.",
                alertProjectLoaded: "Projet chargÃ© avec succÃ¨s !",
                promptEnterFilenameJson: "Entrez le nom du fichier projet (par exemple, mon-projet.json) :",
                promptEnterFilenameDoc: "Entrez le nom du fichier Word (par exemple, mon-livre.doc) :",
                limitReached: "LIMITE ATTEINTE",
                autoSaveMessage: "Projet enregistrÃ© automatiquement !",
                loadAutoSavePrompt: "Un projet enregistrÃ© automatiquement a Ã©tÃ© trouvÃ©. Voulez-vous le charger ?",


                // Page Numbering Controls
                numberingLabel: "NumÃ©rotation :",
                numberingContinue: "Continuer",
                numberingStartNew: "DÃ©marrer Nouveau",
                numberingStartAt: "Commencer Ã  :",

                // Context Menu
                insertImage: "InsÃ©rer Image",
                floatLeft: "Flottant Ã  gauche",
                floatRight: "Flottant Ã  droite",
                noFloat: "Pas de flottement",
                alignLeftNoFloat: "Aligner Ã  gauche (sans flottement)",
                alignCenterNoFloat: "Centrer (sans flottement)",
                alignRightNoFloat: "Aligner Ã  droite (sans flottement)",
                replaceImage: "Remplacer Image",
                removeImage: "Supprimer Image",
                saveAsPdf: "Enregistrer en PDF",
                saveAsWord: "Enregistrer en Word",
                copyUrl: "Copier URL"
            },
            pt: {
                // Menu
                frontCoverBtn: "Capa Frontal",
                kirundiSectionBtn: "SeÃ§Ã£o Kirundi",
                frenchSectionBtn: "SeÃ§Ã£o Francesa",
                englishSectionBtn: "SeÃ§Ã£o Inglesa",
                backCoverBtn: "Capa Traseira",
                openProjectBtn: "Abrir Projeto",
                saveProjectBtn: "Salvar Projeto",
                previewBookBtn: "PrÃ©-visualizar Livro",
                exportPdf: "Exportar para PDF",
                exportDocx: "Salvar como Word (Docx)",
                developedBy: "Desenvolvido por Ndayikeze Apollinaire",
                footerInfo: "Ndayikeze Apollinaire Ã© um especialista em comunicaÃ§Ã£o visual, autor e um pesquisador de TI incansÃ¡vel cujo trabalho em automaÃ§Ã£o une precisÃ£o tÃ©cnica a um propÃ³sito visionÃ¡rio. Com um profundo compromisso em otimizar fluxos de trabalho digitais e aprimorar a capacidade de resposta da plataforma, ele explora continuamente soluÃ§Ãµes inovadoras que capacitam sistemas editoriais, interfaces multilÃ­ngues e comunicaÃ§Ã£o institucional. Sua pesquisa nÃ£o se limita Ã  teoriaâela estÃ¡ inserida em aplicaÃ§Ãµes do mundo real em todo o mundo, onde a automaÃ§Ã£o se torna uma ferramenta para dignidade, clareza e transformaÃ§Ã£o social.",

                // Section Titles
                frontCoverSectionTitle: "Capa Frontal",
                kirundiSectionTitle: "SeÃ§Ã£o Kirundi",
                frenchSectionTitle: "SeÃ§Ã£o Francesa",
                englishSectionTitle: "SeÃ§Ã£o Inglesa",
                backCoverSectionTitle: "Capa Traseira",

                // Placeholders and Labels
                uploadFrontCoverImage: "Carregar imagem da capa frontal:",
                coverPlaceholder: "Carregar imagem da capa frontal",
                bookNumberLabel: "NÃºmero do Livro:",
                bookNumberPlaceholder: "Inserir #",
                kirundiHeaderPlaceholder: "CabeÃ§alho Kirundi (aplica-se a todas as pÃ¡ginas nesta seÃ§Ã£o)",
                kirundiFooterPlaceholder: "RodapÃ© Kirundi (aplica-se a todas as pÃ¡ginas nesta seÃ§Ã£o)",
                frenchHeaderPlaceholder: "CabeÃ§alho FrancÃªs (aplica-se a todas as pÃ¡ginas nesta seÃ§Ã£o)",
                frenchFooterPlaceholder: "RodapÃ© FrancÃªs (aplica-se a todas as pÃ¡ginas nesta seÃ§Ã£o)",
                englishHeaderPlaceholder: "CabeÃ§alho InglÃªs (aplica-se a todas as pÃ¡ginas nesta seÃ§Ã£o)",
                englishFooterPlaceholder: "RodapÃ© InglÃªs (aplica-se a todas as pÃ¡ginas nesta seÃ§Ã£o)",
                mainTitlePlaceholder: (lang, pageNum) => `TÃ­tulo Principal (${lang} - PÃ¡gina ${pageNum})`, // dynamic
                subtitlePlaceholder: (lang, pageNum) => `SubtÃ­tulo Opcional (${lang} - PÃ¡gina ${pageNum})`, // dynamic
                editorPlaceholder: (pageNum) => `Comece a digitar na pÃ¡gina ${pageNum}...`, // dynamic
                captionPlaceholder: "Inserir legenda aqui...",
                uploadDesignPrompt: "Clique ou arraste o arquivo para esta Ã¡rea para carregar",
                uploadBackCoverImage: "Carregar imagem da capa traseira:",
                backCoverPlaceholder: "Carregar imagem da capa traseira",

                // Toolbar
                undo: "Desfazer", redo: "Refazer", quote: "CitaÃ§Ã£o", bold: "Negrito", italic: "ItÃ¡lico", underline: "Sublinhar",
                bulletList: "Lista com marcadores", numberedList: "Lista numerada", indent: "Recuar", outdent: "Remover Recuo",
                copy: "Copiar", cut: "Cortar", paste: "Colar", delete: "Excluir", selectAll: "Selecionar Tudo",
                fontSize: "Tamanho", font: "Fonte", textColor: "Cor do Texto",
                alignLeft: "Alinhar Ã  Esquerda", alignCenter: "Centrar", alignRight: "Alinhar Ã  Direita", justify: "Justificar",
                twoColumns: "2 Colunas", threeColumns: "3 Colunas", oneColumn: "1 Coluna (Remover Colunas)",

                // Page Controls
                addPage: "Adicionar Nova PÃ¡gina",
                addDesign: "Adicionar um Design",
                removePageTitle: "Remover esta pÃ¡gina",
                hidePageNumberTitle: "Ocultar nÃºmero da pÃ¡gina",

                // System messages
                alertSelectTextForColumns: "Por favor, selecione o texto que deseja formatar em colunas.",
                alertAllowPopups: "Por favor, permita pop-ups para este site para ver a prÃ©-visualizaÃ§Ã£o.",
                alertCouldNotExportPdf: "NÃ£o foi possÃ­vel exportar para PDF. Por favor, abra a prÃ©-visualizaÃ§Ã£o no editor principal.",
                alertCouldNotExportWord: "NÃ£o foi possÃ­vel exportar para Word. Por favor, abra a prÃ©-visualizaÃ§Ã£o no editor principal.",
                alertMainEditorUrlCopied: "URL do editor principal copiado para a Ã¡rea de transferÃªncia! O conteÃºdo da prÃ©-visualizaÃ§Ã£o Ã© dinÃ¢mico e nÃ£o pode ser endereÃ§ado diretamente por um URL persistente.",
                alertFailedToCopyUrl: "Falha ao copiar URL.",
                confirmRemovePage: "Tem certeza de que deseja remover esta pÃ¡gina e todo o seu conteÃºdo?",
                alertCannotDeleteLastTextPage: "VocÃª nÃ£o pode excluir a Ãºnica pÃ¡gina de texto em uma seÃ§Ã£o. Adicione outra pÃ¡gina primeiro, se desejar substituÃ­-la.",
                alertErrorOpeningProject: "Erro: NÃ£o foi possÃ­vel abrir ou analisar o arquivo do projeto.",
                alertProjectLoaded: "Projeto carregado com sucesso!",
                promptEnterFilenameJson: "Insira o nome do arquivo do projeto (ex: meu-projeto.json):",
                promptEnterFilenameDoc: "Insira o nome do arquivo Word (ex: meu-livro.doc):",
                limitReached: "LIMITE ATINGIDO",
                autoSaveMessage: "Projeto salvo automaticamente!",
                loadAutoSavePrompt: "Um projeto salvo automaticamente foi encontrado. Deseja carregÃ¡-lo?",


                // Page Numbering Controls
                numberingLabel: "NumeraÃ§Ã£o:",
                numberingContinue: "Continuar",
                numberingStartNew: "Iniciar Novo",
                numberingStartAt: "Iniciar em:",

                // Context Menu
                insertImage: "Inserir Imagem",
                floatLeft: "Flutuar Ã  Esquerda",
                floatRight: "Flutuar Ã  Direita",
                noFloat: "Sem FlutuaÃ§Ã£o",
                alignLeftNoFloat: "Alinhar Ã  Esquerda (sem flutuaÃ§Ã£o)",
                alignCenterNoFloat: "Centrar (sem flutuaÃ§Ã£o)",
                alignRightNoFloat: "Alinhar Ã  Direita (sem flutuaÃ§Ã£o)",
                replaceImage: "Substituir Imagem",
                removeImage: "Remover Imagem",
                saveAsPdf: "Salvar como PDF",
                saveAsWord: "Salvar como Word",
                copyUrl: "Copiar URL"
            }
        };

        function applyTranslations(lang) {
            const currentTranslation = translations[lang];

            // Update elements with data-i18n attribute (text content)
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslation[key]) {
                    element.textContent = currentTranslation[key];
                }
            });

            // Update elements with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (currentTranslation[key]) {
                    // Handle dynamic placeholders for titles and editor content
                    if (key.includes('TitlePlaceholder') || key.includes('SubtitlePlaceholder') || key === 'editorPlaceholder') {
                         const pageWrapper = element.closest('.page-wrapper');
                         if (pageWrapper) {
                             const sectionEl = pageWrapper.closest('.book-section');
                             const sectionLangKey = sectionEl ? sectionEl.dataset.sectionLang : null;
                             const sectionTitleTranslation = sectionLangKey ? translations[lang][`${sectionLangKey}SectionTitle`] || sectionLangKey : '';
                             const pageNum = Array.from(pageWrapper.parentElement.querySelectorAll('.page-wrapper')).indexOf(pageWrapper) + 1;

                             if (key.includes('TitlePlaceholder') || key.includes('SubtitlePlaceholder')) {
                                element.placeholder = currentTranslation[key](sectionTitleTranslation, pageNum);
                             } else if (key === 'editorPlaceholder') {
                                 element.dataset.placeholder = currentTranslation[key](pageNum);
                                 updatePlaceholder(element); // Re-trigger placeholder visibility check
                             }
                         } else { // Fallback for elements not inside page-wrappers (e.g., initial templates)
                             element.placeholder = currentTranslation[key];
                         }
                    } else if (key === 'captionPlaceholder') {
                        element.dataset.placeholder = currentTranslation[key];
                    }
                    else {
                        element.placeholder = currentTranslation[key];
                    }
                }
            });

            // Update elements with data-i18n-title attribute (for tooltips)
            document.querySelectorAll('[data-i18n-title]').forEach(element => {
                const key = element.getAttribute('data-i18n-title');
                if (currentTranslation[key]) {
                    element.title = currentTranslation[key];
                }
            });

            // Update toolbar button titles explicitly (they don't always have data-i18n-title)
            document.querySelector('[onclick="formatText(\'undo\', event)"]').title = currentTranslation.undo;
            document.querySelector('[onclick="formatText(\'redo\', event)"]').title = currentTranslation.redo;
            document.querySelector('[onclick="toggleQuote(event)"]').title = currentTranslation.quote;
            document.querySelector('[onclick="formatText(\'bold\', event)"]').title = currentTranslation.bold;
            document.querySelector('[onclick="formatText(\'italic\', event)"]').title = currentTranslation.italic;
            document.querySelector('[onclick="formatText(\'underline\', event)"]').title = currentTranslation.underline;
            document.querySelector('[onclick="formatText(\'insertUnorderedList\', event)"]').title = currentTranslation.bulletList;
            document.querySelector('[onclick="formatText(\'insertOrderedList\', event)"]').title = currentTranslation.numberedList;
            document.querySelector('[onclick="formatText(\'indent\', event)"]').title = currentTranslation.indent;
            document.querySelector('[onclick="formatText(\'outdent\', event)"]').title = currentTranslation.outdent;
            document.querySelector('[onclick="formatText(\'copy\', event)"]').title = currentTranslation.copy;
            document.querySelector('[onclick="formatText(\'cut\', event)"]').title = currentTranslation.cut;
            document.querySelector('[onclick="handlePaste(event)"]').title = currentTranslation.paste;
            document.querySelector('[onclick="formatText(\'delete\', event)"]').title = currentTranslation.delete;
            document.querySelector('[onclick="selectAllText(event)"]').title = currentTranslation.selectAll;
            document.querySelector('select[onchange="setFontSize(this.value, event)"]').title = currentTranslation.fontSize;
            document.querySelector('select[onchange="setFontName(this.value, event)"]').title = currentTranslation.font;
            document.querySelector('input[type="color"][oninput="setTextColor(this.value, event)"]').title = currentTranslation.textColor;
            document.querySelector('[onclick="formatText(\'justifyLeft\', event)"]').title = currentTranslation.alignLeft;
            document.querySelector('[onclick="formatText(\'justifyCenter\', event)"]').title = currentTranslation.alignCenter;
            document.querySelector('[onclick="formatText(\'justifyRight\', event)"]').title = currentTranslation.alignRight;
            document.querySelector('[onclick="formatText(\'justifyFull\', event)"]').title = currentTranslation.justify;
            document.querySelector('[onclick="formatColumns(2, event)"]').title = currentTranslation.twoColumns;
            document.querySelector('[onclick="formatColumns(3, event)"]').title = currentTranslation.threeColumns;
            document.querySelector('[onclick="removeColumns(event)"]').title = currentTranslation.oneColumn;


            // Update page numbering labels explicitly
            document.querySelector('label[for="continue-kirundi"]').textContent = currentTranslation.numberingContinue;
            document.querySelector('label[for="start-new-kirundi"]').textContent = currentTranslation.numberingStartNew;
            document.querySelector('label[for="start-from-kirundi"]').textContent = currentTranslation.numberingStartAt;
            document.querySelector('label[for="continue-french"]').textContent = currentTranslation.numberingContinue;
            document.querySelector('label[for="start-new-french"]').textContent = currentTranslation.numberingStartNew;
            document.querySelector('label[for="start-from-french"]').textContent = currentTranslation.numberingStartAt;
            document.querySelector('label[for="continue-english"]').textContent = currentTranslation.numberingContinue;
            document.querySelector('label[for="start-new-english"]').textContent = currentTranslation.numberingStartNew;
            document.querySelector('label[for="start-from-english"]').textContent = currentTranslation.numberingStartAt;

            // Update context menu items
            document.getElementById('insert-image-option').querySelector('span') ? document.getElementById('insert-image-option').querySelector('span').textContent = currentTranslation.insertImage : document.getElementById('insert-image-option').innerHTML = `<i class="fas fa-image"></i> ${currentTranslation.insertImage}`;
            document.getElementById('float-left-option').querySelector('span') ? document.getElementById('float-left-option').querySelector('span').textContent = currentTranslation.floatLeft : document.getElementById('float-left-option').innerHTML = `<i class="fas fa-align-left"></i> ${currentTranslation.floatLeft}`;
            document.getElementById('float-right-option').querySelector('span') ? document.getElementById('float-right-option').querySelector('span').textContent = currentTranslation.floatRight : document.getElementById('float-right-option').innerHTML = `<i class="fas fa-align-right"></i> ${currentTranslation.floatRight}`;
            document.getElementById('no-float-option').querySelector('span') ? document.getElementById('no-float-option').querySelector('span').textContent = currentTranslation.noFloat : document.getElementById('no-float-option').innerHTML = `<i class="fas fa-grip-lines"></i> ${currentTranslation.noFloat}`;
            document.getElementById('align-left-option').querySelector('span') ? document.getElementById('align-left-option').querySelector('span').textContent = currentTranslation.alignLeftNoFloat : document.getElementById('align-left-option').innerHTML = `<i class="fas fa-align-left"></i> ${currentTranslation.alignLeftNoFloat}`;
            document.getElementById('align-center-option').querySelector('span') ? document.getElementById('align-center-option').querySelector('span').textContent = currentTranslation.alignCenterNoFloat : document.getElementById('align-center-option').innerHTML = `<i class="fas fa-align-center"></i> ${currentTranslation.alignCenterNoFloat}`;
            document.getElementById('align-right-option').querySelector('span') ? document.getElementById('align-right-option').querySelector('span').textContent = currentTranslation.alignRightNoFloat : document.getElementById('align-right-option').innerHTML = `<i class="fas fa-align-right"></i> ${currentTranslation.alignRightNoFloat}`;
            document.getElementById('replace-image-option').querySelector('span') ? document.getElementById('replace-image-option').querySelector('span').textContent = currentTranslation.replaceImage : document.getElementById('replace-image-option').innerHTML = `<i class="fas fa-sync-alt"></i> ${currentTranslation.replaceImage}`;
            document.getElementById('remove-image-option').querySelector('span') ? document.getElementById('remove-image-option').querySelector('span').textContent = currentTranslation.removeImage : document.getElementById('remove-image-option').innerHTML = `<i class="fas fa-trash-alt"></i> ${currentTranslation.removeImage}`;
        }

        function updateDynamicPlaceholders(lang) {
            const currentTranslation = translations[lang];
            SECTION_ORDER.forEach(sectionLang => {
                const sectionEl = document.getElementById(`${sectionLang}-section`);
                if (sectionEl) {
                    sectionEl.querySelectorAll('.page-wrapper').forEach((pageWrapper, index) => {
                        const pageNum = index + 1;
                        if (pageWrapper.dataset.pageType === 'text') {
                            const mainTitleInput = pageWrapper.querySelector('.main-title');
                            const subtitleInput = pageWrapper.querySelector('.subtitle');
                            const editorDiv = pageWrapper.querySelector('.master-text-editor');
                            const sectionTitleTranslation = translations[lang][`${sectionLang}SectionTitle`] || sectionLang;

                            if (mainTitleInput) mainTitleInput.placeholder = currentTranslation.mainTitlePlaceholder(sectionTitleTranslation, pageNum);
                            if (subtitleInput) subtitleInput.placeholder = currentTranslation.subtitlePlaceholder(sectionTitleTranslation, pageNum);
                            if (editorDiv) {
                                editorDiv.dataset.placeholder = currentTranslation.editorPlaceholder(pageNum);
                                updatePlaceholder(editorDiv); // Re-trigger placeholder visibility check
                            }
                        } else if (pageWrapper.dataset.pageType === 'design') {
                            const uploadPromptDiv = pageWrapper.querySelector('.upload-prompt div');
                            if (uploadPromptDiv) uploadPromptDiv.textContent = currentTranslation.uploadDesignPrompt;
                        }
                    });
                }
            });
            // Update caption placeholders for existing images
            document.querySelectorAll('.image-with-caption figcaption').forEach(figcaption => {
                figcaption.dataset.placeholder = currentTranslation.captionPlaceholder;
            });
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        let draggedElement = null; // For drag and drop

        function updateAllPageNumbers() {
            let currentPageNumber = 1;
            for (const lang of SECTION_ORDER) {
                const section = document.getElementById(`${lang}-section`);
                if (!section) continue;
                const selectedOption = section.querySelector(`input[name="numbering-${lang}"]:checked`).value;
                const startInput = section.querySelector(`#start-input-${lang}`);
                const pageWrappers = section.querySelectorAll('.page-wrapper');
                pageWrappers.forEach((page, index) => {
                    if (index === 0) {
                        switch (selectedOption) {
                            case 'continue': break;
                            case 'start_new': currentPageNumber = 1; break;
                            case 'start_from': currentPageNumber = parseInt(startInput.value, 10) || 1; break;
                        }
                    }
                    const pageNumberSpan = page.querySelector('.page-number');
                    if (pageNumberSpan) {
                        pageNumberSpan.textContent = currentPageNumber;
                    }
                    currentPageNumber++;
                });
            }
        }

        function initializeNumberingControls() {
            for (const lang of SECTION_ORDER) {
                const section = document.getElementById(`${lang}-section`);
                if (!section) continue;
                const controls = section.querySelectorAll(`input[name="numbering-${lang}"]`);
                const startInput = section.querySelector(`#start-input-${lang}`);
                controls.forEach(radio => {
                    radio.addEventListener('change', () => {
                        updateAllPageNumbers();
                    });
                });
                startInput.addEventListener('input', updateAllPageNumbers);
            }
        }

        function showSection(sectionId, clickedButton = null) {
            document.querySelectorAll('.book-section').forEach(section => {
                section.style.display = 'none';
            });
            const activeSectionElement = document.getElementById(sectionId + '-section');
            if (activeSectionElement) {
                activeSectionElement.style.display = 'block';
            }
            document.querySelectorAll('.menu-column nav ul li button').forEach(button => {
                button.classList.remove('active');
            });
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                const btn = document.getElementById('show' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1).replace('-', '') + 'Btn');
                if (btn) btn.classList.add('active');
            }
        }

        function getEditorFromEvent(event) {
            let target = event.target.closest('button, select, input');
            return target.closest('.page-wrapper').querySelector('.master-text-editor');
        }

        function formatText(command, event) {
            const editor = getEditorFromEvent(event);
            editor.focus();
            // All toolbar buttons remain active
            // Toolbar state is always available.
            // All interactions should behave predictably.
            // Placeholder and limit check are handled by debounced input listener.
            document.execCommand(command, false, null);
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }

        function setTextColor(color, event) {
            const editor = getEditorFromEvent(event);
            editor.focus();
            document.execCommand('foreColor', false, color);
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }

        function setFontSize(size, event) {
            const editor = getEditorFromEvent(event);
            editor.focus();
            if (size) document.execCommand('fontSize', false, size);
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }

        function setFontName(fontName, event) {
            const editor = getEditorFromEvent(event);
            editor.focus();
            if (fontName) document.execCommand('fontName', false, fontName);
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }

        function formatColumns(count, event) {
            const editor = getEditorFromEvent(event);
            editor.focus();
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                alert(translations[currentLanguage].alertSelectTextForColumns);
                return;
            }
            const range = selection.getRangeAt(0);
            const selectedContent = range.extractContents();
            const columnWrapper = document.createElement('div');
            columnWrapper.style.columnCount = count;
            columnWrapper.style.columnGap = '20px';
            columnWrapper.style.marginBottom = '1em';
            columnWrapper.appendChild(selectedContent);
            if (columnWrapper.firstElementChild) {
                columnWrapper.firstElementChild.style.marginTop = '0';
            }
            range.insertNode(columnWrapper);
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }
        
        function removeColumns(event) {
            formatColumns(1, event); // Revert to 1 column
            const editor = getEditorFromEvent(event);
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }

        function selectAllText(event) {
            const editor = getEditorFromEvent(event);
            editor.focus();
            document.execCommand('selectAll', false, null);
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }

        function toggleQuote(event) {
            const editor = getEditorFromEvent(event);
            editor.focus();
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer.nodeType === 1 ? range.commonAncestorContainer : range.commonAncestorContainer.parentElement;
            
            const existingQuote = container.closest('blockquote.custom-quote');
            
            if (existingQuote) {
                const content = document.createDocumentFragment();
                while(existingQuote.firstChild) {
                    content.appendChild(existingQuote.firstChild);
                }
                existingQuote.parentNode.replaceChild(content, existingQuote);
                document.execCommand('removeFormat', false, null);
            } else {
                document.execCommand('formatBlock', false, 'blockquote');
                const blockquote = editor.querySelector('blockquote:not(.custom-quote)');
                if (blockquote) {
                    blockquote.className = 'custom-quote';
                }
            }
            editor.dispatchEvent(new Event('input')); // Trigger input event for debounce
        }

        const textContextMenu = document.getElementById('text-context-menu');
        const imageContextMenu = document.getElementById('image-context-menu');
        const imageInserter = document.getElementById('image-inserter');
        let lastSelectionRange = null;
        let rightClickedFigure = null;
        let activeEditor = null;
        let imageAction = 'insert';

        document.addEventListener('contextmenu', (event) => {
            const target = event.target;
            const editor = target.closest('.master-text-editor');
            textContextMenu.style.display = 'none';
            imageContextMenu.style.display = 'none';
            if (editor) {
                event.preventDefault();
                activeEditor = editor;
                const imageFigure = target.closest('.image-with-caption');
                if (imageFigure) {
                    rightClickedFigure = imageFigure;
                    showContextMenu(imageContextMenu, event.pageX, event.pageY);
                    // Dynamically show/hide float/alignment options
                    document.getElementById('float-left-option').style.display = 'list-item';
                    document.getElementById('float-right-option').style.display = 'list-item';
                    document.getElementById('no-float-option').style.display = 'list-item';
                    const isFloated = rightClickedFigure.classList.contains('float-left') || rightClickedFigure.classList.contains('float-right');
                    document.getElementById('align-left-option').style.display = isFloated ? 'none' : 'list-item';
                    document.getElementById('align-center-option').style.display = isFloated ? 'none' : 'list-item';
                    document.getElementById('align-right-option').style.display = isFloated ? 'none' : 'list-item';
                } else {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        lastSelectionRange = selection.getRangeAt(0).cloneRange();
                    }
                    showContextMenu(textContextMenu, event.pageX, event.pageY);
                }
            }
        });

        function showContextMenu(menu, x, y) {
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
        }

        document.addEventListener('click', () => {
            textContextMenu.style.display = 'none';
            imageContextMenu.style.display = 'none';
        });

        document.getElementById('insert-image-option').addEventListener('click', (event) => {
            event.stopPropagation();
            imageAction = 'insert';
            imageInserter.click();
        });
        document.getElementById('replace-image-option').addEventListener('click', () => { if (rightClickedFigure) { imageAction = 'replace'; imageInserter.click(); } });
        document.getElementById('remove-image-option').addEventListener('click', () => { 
            if (rightClickedFigure) { 
                rightClickedFigure.remove(); 
                rightClickedFigure = null; 
                activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
            } 
        });
        
        function clearImageClasses(figure) {
            figure.classList.remove('float-left', 'float-right', 'align-left', 'align-center', 'align-right');
        }

        document.getElementById('float-left-option').addEventListener('click', () => {
            if (rightClickedFigure) {
                clearImageClasses(rightClickedFigure);
                rightClickedFigure.classList.add('float-left');
                // Hide alignment options when floated
                document.getElementById('align-left-option').style.display = 'none';
                document.getElementById('align-center-option').style.display = 'none';
                document.getElementById('align-right-option').style.display = 'none';
                activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
            }
        });
        document.getElementById('float-right-option').addEventListener('click', () => {
            if (rightClickedFigure) {
                clearImageClasses(rightClickedFigure);
                rightClickedFigure.classList.add('float-right');
                // Hide alignment options when floated
                document.getElementById('align-left-option').style.display = 'none';
                document.getElementById('align-center-option').style.display = 'none';
                document.getElementById('align-right-option').style.display = 'none';
                activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
            }
        });
        document.getElementById('no-float-option').addEventListener('click', () => {
            if (rightClickedFigure) {
                clearImageClasses(rightClickedFigure);
                rightClickedFigure.classList.add('align-center'); // Default to center if no float
                // Show alignment options when not floated
                document.getElementById('align-left-option').style.display = 'list-item';
                document.getElementById('align-center-option').style.display = 'list-item';
                document.getElementById('align-right-option').style.display = 'list-item';
                activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
            }
        });

        document.getElementById('align-left-option').addEventListener('click', () => {
            if (rightClickedFigure && !rightClickedFigure.classList.contains('float-left') && !rightClickedFigure.classList.contains('float-right')) {
                clearImageClasses(rightClickedFigure);
                rightClickedFigure.classList.add('align-left');
                activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
            }
        });
        document.getElementById('align-center-option').addEventListener('click', () => {
            if (rightClickedFigure && !rightClickedFigure.classList.contains('float-left') && !rightClickedFigure.classList.contains('float-right')) {
                clearImageClasses(rightClickedFigure);
                rightClickedFigure.classList.add('align-center');
                activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
            }
        });
        document.getElementById('align-right-option').addEventListener('click', () => {
            if (rightClickedFigure && !rightClickedFigure.classList.contains('float-left') && !rightClickedFigure.classList.contains('float-right')) {
                clearImageClasses(rightClickedFigure);
                rightClickedFigure.classList.add('align-right');
                activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
            }
        });

        imageInserter.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                if (imageAction === 'insert') {
                    if (lastSelectionRange && activeEditor) {
                        activeEditor.focus();
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(lastSelectionRange);

                        const figure = document.createElement('figure');
                        figure.className = 'image-with-caption'; // Inline block, no initial float/align class
                        figure.contentEditable = false;
                        figure.draggable = false; // Not draggable as an inline object
                        
                        const container = document.createElement('div');
                        container.className = 'resizable-image-container';
                        // Set a default size for the resizable container to make it visible and resizable
                        container.style.width = '150px'; 
                        container.style.height = 'auto'; // Let height adjust naturally, maintaining aspect ratio

                        const img = document.createElement('img');
                        img.src = dataUrl;
                        const figcaption = document.createElement('figcaption');
                        figcaption.contentEditable = true;
                        figcaption.dataset.placeholder = translations[currentLanguage].captionPlaceholder;
                        container.appendChild(img);
                        figure.appendChild(container);
                        figure.appendChild(figcaption);
                        
                        const range = sel.getRangeAt(0);
                        range.deleteContents(); // Remove any selected content before inserting
                        range.insertNode(figure); // Insert the figure at the cursor location

                        // Move caret immediately after the inserted image
                        range.setStartAfter(figure);
                        selection.removeAllRanges();
                        selection.addRange(range);

                        activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
                    }
                } else if (imageAction === 'replace' && rightClickedFigure) {
                    const imgToReplace = rightClickedFigure.querySelector('img');
                    if (imgToReplace) imgToReplace.src = dataUrl;
                    activeEditor.dispatchEvent(new Event('input')); // Trigger input event for debounce
                }
                imageInserter.value = null;
                rightClickedFigure = null;
                activeEditor = null;
                imageAction = 'insert';
            };
            reader.readAsDataURL(file);
        });

        function addPage(lang, type = 'text') {
            const container = document.getElementById(`pages-container-${lang}`);
            const newPageWrapper = document.createElement('div');
            newPageWrapper.className = 'page-wrapper';
            newPageWrapper.dataset.pageType = type;
            const pageNum = container.querySelectorAll('.page-wrapper').length + 1; // Count all page types for simple numbering

            if (type === 'text') {
                 newPageWrapper.innerHTML = `
                    <div class="rich-text-editor-container">
                        <div class="title-section">
                            <div class="main-title-container">
                                <input type="text" class="main-title" data-i18n-placeholder="mainTitlePlaceholder" placeholder="${translations[currentLanguage].mainTitlePlaceholder(translations[currentLanguage][`${lang}SectionTitle`] || lang, pageNum)}">
                            </div>
                            <div class="subtitle-container"><input type="text" class="subtitle" data-i18n-placeholder="subtitlePlaceholder" placeholder="${translations[currentLanguage].subtitlePlaceholder(translations[currentLanguage][`${lang}SectionTitle`] || lang, pageNum)}"></div>
                        </div>
                        <div class="editor-toolbar">
                             <button onclick="formatText('undo', event)" data-i18n-title="undo"><i class="fas fa-undo"></i></button><button onclick="formatText('redo', event)" data-i18n-title="redo"><i class="fas fa-redo"></i></button><button onclick="toggleQuote(event)" data-i18n-title="quote"><i class="fas fa-quote-left"></i></button><button onclick="formatText('bold', event)" data-i18n-title="bold"><i class="fas fa-bold"></i></button><button onclick="formatText('italic', event)" data-i18n-title="italic"><i class="fas fa-italic"></i></button><button onclick="formatText('underline', event)" data-i18n-title="underline"><i class="fas fa-underline"></i></button>
                             <button onclick="formatText('insertUnorderedList', event)" data-i18n-title="bulletList"><i class="fas fa-list-ul"></i></button>
                             <button onclick="formatText('insertOrderedList', event)" data-i18n-title="numberedList"><i class="fas fa-list-ol"></i></button>
                             <button onclick="formatText('indent', event)" data-i18n-title="indent"><i class="fas fa-indent"></i></button>
                             <button onclick="formatText('outdent', event)" data-i18n-title="outdent"><i class="fas fa-outdent"></i></button>
                             <button onclick="formatText('copy', event)" data-i18n-title="copy"><i class="fas fa-copy"></i></button><button onclick="formatText('cut', event)" data-i18n-title="cut"><i class="fas fa-cut"></i></button><button onclick="handlePaste(event)" data-i18n-title="paste"><i class="fas fa-paste"></i></button><button onclick="formatText('delete', event)" data-i18n-title="delete"><i class="fas fa-trash"></i></button><button onclick="selectAllText(event)" data-i18n-title="selectAll"><i class="fas fa-object-group"></i> <span data-i18n="selectAll">Select All</span></button><select onchange="setFontSize(this.value, event)" data-i18n-title="fontSize"><option value="">Size</option><option value="1">Small</option><option value="2">Normal</option><option value="3">Medium</option><option value="4">Large</option><option value="5">X-Large</option><option value="6">XX-Large</option><option value="7">Huge</option></select><select onchange="setFontName(this.value, event)" data-i18n-title="font"><option value="">Font</option><option value="Arial">Arial</option><option value="Verdana">Verdana</option><option value="Times New Roman">Times New Roman</option><option value="Georgia">Georgia</option><option value="Courier New">Courier New</option><option value="Lucida Console">Lucida Console</option></select><input type="color" oninput="setTextColor(this.value, event)" data-i18n-title="textColor"><button onclick="formatText('justifyLeft', event)" data-i18n-title="alignLeft"><i class="fas fa-align-left"></i></button><button onclick="formatText('justifyCenter', event)" data-i18n-title="alignCenter"><i class="fas fa-align-center"></i></button><button onclick="formatText('justifyRight', event)" data-i18n-title="alignRight"><i class="fas fa-align-right"></i></button><button onclick="formatText('justifyFull', event)" data-i18n-title="justify"><i class="fas fa-align-justify"></i></button><button onclick="formatColumns(2, event)" data-i18n-title="twoColumns"><i class="fas fa-columns"></i> 2</button><button onclick="formatColumns(3, event)" data-i18n-title="threeColumns"><i class="fas fa-columns"></i> 3</button><button onclick="removeColumns(event)" data-i18n-title="oneColumn"><i class="fas fa-columns"></i> 1</button>
                        </div>
                        <div class="master-text-editor" contenteditable="true" data-i18n-placeholder="editorPlaceholder" data-placeholder="${translations[currentLanguage].editorPlaceholder(pageNum)}"></div>
                    </div>
                    <div class="limit-indicator" data-i18n="limitReached">LIMIT REACHED</div>
                    <div class="page-footer-container">
                        <div class="page-controls-container">
                            <button class="remove-page-btn" data-i18n-title="removePageTitle"><i class="fas fa-trash-alt"></i></button>
                            <div class="page-number-container">
                                <span class="page-number">0</span>
                                <span class="remove-page-number" data-i18n-title="hidePageNumberTitle">&times;</span>
                            </div>
                        </div>
                    </div>`;
            } else if (type === 'design') {
                newPageWrapper.innerHTML = `
                    <div class="design-page-container">
                        <div class="upload-prompt">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div data-i18n="uploadDesignPrompt">${translations[currentLanguage].uploadDesignPrompt}</div>
                        </div>
                        <img class="design-preview-img" src="#">
                        <input type="file" accept="image/*" style="display: none;">
                    </div>
                     <div class="page-footer-container">
                        <div class="page-controls-container">
                            <button class="remove-page-btn" data-i18n-title="removePageTitle"><i class="fas fa-trash-alt"></i></button>
                            <div class="page-number-container">
                                <span class="page-number">0</span>
                                <span class="remove-page-number" data-i18n-title="hidePageNumberTitle">&times;</span>
                            </div>
                        </div>
                    </div>`;
            }

            container.appendChild(newPageWrapper);
            const newEditor = newPageWrapper.querySelector('.master-text-editor');
            if (newEditor) {
                const debouncedUpdatePlaceholder = debounce(updatePlaceholder, 200);
                const debouncedCheckContentLimit = debounce(checkContentLimit, 200);

                newEditor.addEventListener('paste', handlePaste);
                newEditor.addEventListener('input', () => {
                    debouncedUpdatePlaceholder(newEditor);
                    debouncedCheckContentLimit(newEditor);
                });
                newEditor.addEventListener('scroll', () => debouncedCheckContentLimit(newEditor)); // For good measure
                debouncedCheckContentLimit(newEditor); // Initial check
                
                newPageWrapper.querySelectorAll('.main-title, .subtitle').forEach(updateLayoutForEmptyInputs);
                debouncedUpdatePlaceholder(newEditor);
            }
            updateAllPageNumbers();
        }

        // Helper function to determine if a page has visual elements
        function hasVisualElements(pageElement) {
            // Check for images
            if (pageElement.querySelector('img')) return true;
            // Check for figures (which can contain images or other media)
            if (pageElement.querySelector('figure')) return true;
            // Check for custom quotes (styled blocks)
            if (pageElement.querySelector('blockquote.custom-quote')) return true;
            // Check for column wrappers
            if (pageElement.querySelector('div[style*="column-count"]')) return true;
            // Check for any non-empty div/p that is not just whitespace
            if (pageElement.querySelectorAll('div, p, ul, ol, li').length > 0) {
                let hasMeaningfulText = false;
                pageElement.querySelectorAll('div, p, ul, ol, li').forEach(el => {
                    // Ignore empty containers if they only contain whitespace or no visible content
                    const innerText = el.textContent.trim();
                    const innerHtml = el.innerHTML.trim();
                    if (innerText.length > 0 || innerHtml.includes('<img') || innerHtml.includes('<figure')) {
                        hasMeaningfulText = true;
                    }
                });
                if (hasMeaningfulText) return true;
            }
            return false;
        }


        function generatePreviewHtml(forWord = false) {
            let style = `
            <style>
                @charset "UTF-8";
                @page { size: 210mm 287mm; margin: 0; }
                * { box-sizing: border-box; }
                body {
                    font-family: 'Times New Roman', Times, serif; line-height: 1.5;
                    margin: 0; padding: 0; background-color: #e9e9e9;
                    -webkit-print-color-adjust: exact; print-color-adjust: exact;
                }
                .preview-container {
                    margin: 0; padding: 20px 0; display: flex;
                    flex-direction: column; align-items: center; gap: 20px;
                }
                .page {
                    width: 210mm; height: 287mm; box-sizing: border-box;
                    page-break-after: always; background: #fff;
                    font-size: 12pt; color: #000;
                    box-shadow: 0 0 10px rgba(0,0,0,0.2);
                    position: relative;
                }
                .page:last-of-type { page-break-after: auto; }
                .cover-page-preview, .design-page-preview {
                    padding: 0; display: flex; align-items: center; justify-content: center;
                }
                .cover-page-preview { position: relative; }
                .cover-page-preview img, .design-page-preview img {
                    width: 100%; height: 100%; object-fit: cover;
                }
                .design-page-preview img { object-fit: contain; }
                .book-number-preview {
                    position: absolute; bottom: 1in; right: 1in; z-index: 2;
                    background-color: rgba(255, 255, 255, 0.9); color: #000;
                    padding: 5pt 10pt; border-radius: 3px; font-size: 12pt; font-weight: bold;
                }
                .header {
                    position: absolute; top: 0; left: 0; right: 0; height: 0.5in;
                    padding: 0 1in;
                    font-size: 9pt; color: #444; display: flex; 
                    align-items: center; justify-content: center;
                }
                .content {
                    padding: 0.5in 1in calc(1in + 22px) 1in; /* Lift footer by adding to bottom padding */
                    height: 100%;
                    overflow: hidden; /* Hide overflow to protect footer area */
                    font-family: 'Times New Roman', Times, serif; /* Default font for content */
                    line-height: 1.5; /* Ensure line spacing is respected */
                }
                .content p {
                    line-height: 1.5; /* Apply line-height to paragraphs */
                    margin-top: 0;
                    margin-bottom: 0.5em;
                }
                .footer {
                    position: absolute; bottom: 22px; /* Lift footer upward by 22px (approx 0.8cm) */ left: 0; right: 0; height: 1in;
                    padding: 0 1in 0.5in 1in;
                    display: flex; align-items: flex-end;
                    justify-content: space-between;
                    border-top: 1px solid #ddd;
                }
                .footer-text-container-preview {
                    background-color: #c0392b; color: white; padding: 4px 10px;
                    border-radius: 5px; font-size: 12px;
                }
                .page-number-container-preview {
                    background-color: #27ae60; color: white; padding: 4px 10px;
                    border-radius: 5px; font-weight: bold; font-size: 14px;
                }

                .main-title-container-preview {
                    margin: 0 auto 0.25in auto; padding: 0.15in; padding-bottom: calc(0.15in + 8px);
                    text-align: center; background-color: #009E60; color: #ffffff;
                    border-radius: 8px; position: relative; overflow: hidden;
                }
                .main-title-container-preview::before, .main-title-container-preview::after {
                    content: ''; position: absolute; left: 0; width: 100%; height: 4px;
                }
                .main-title-container-preview::before { background-color: #F4F5F0; bottom: 4px; }
                .main-title-container-preview::after { background-color: #CD212A; bottom: 0; }
                .main-title-container-preview h1 {
                    margin: 0; padding: 0; font-size: 24pt; font-weight: bold; line-height: 1.2;
                }
                .subtitle-wrapper { text-align: center; margin-bottom: 0.25in; }
                .subtitle-wrapper h2 {
                    display: inline-block; margin: 0; padding: 0 0 4pt 0; font-size: 14pt;
                    font-weight: bold; color: #c0392b; border-bottom: 2pt solid #c0392b;
                }
                
                .content div, .content blockquote { margin-top: 0; margin-bottom: 1em; }
                
                /* Preview styles for images */
                .content figure {
                    display: inline-block; /* Inline object */
                    vertical-align: middle; /* Align with text baseline */
                    margin: 0 0.5em; /* Small horizontal margin to separate from text */
                    max-width: 100%; /* Ensure it doesn't exceed editor width */
                    width: auto; /* Allow auto width or specific inline width */
                    resize: none; /* Disable resizing in print output */
                    overflow: hidden; /* Hide resize handles in print output */
                }
                /* Remove float/align specific classes for preview */
                .content figure.float-left, .content figure.float-right,
                .content figure.align-left, .content figure.align-center, .content figure.align-right {
                    float: none;
                    margin: 0 0.5em;
                    clear: none;
                    text-align: initial;
                }

                .content figure .resizable-image-container {
                    /* Inherit dimensions or set explicit for print */
                    width: inherit; /* Should take width from figure inline style */
                    height: inherit; /* Should take height from figure inline style */
                    resize: none; /* Disable resizing in print output */
                    overflow: hidden;
                    border: none;
                    cursor: default;
                }

                .content figure img { max-width: 100%; height: auto; display: block; }
                .content figcaption {
                    font-size: 10pt; font-style: italic; color: #000; /* Set to black for readability */
                    padding-top: 8pt; /* Increased padding for clear separation */
                    text-align: center;
                    display: block;
                }
                .content div[style*="column-count"] { margin-top: 1em; margin-bottom: 1em; }
                .content .custom-quote {
                    position: relative; margin: 1em 0; padding: 0.1in 0.15in 0.1in 25px;
                    font-style: italic; background-color: #f5f5f5; border-radius: 4px; page-break-inside: avoid;
                }
                .content .custom-quote::before {
                    content: ''; position: absolute; left: 8px; top: 5px; bottom: 5px; width: 9px;
                    background: linear-gradient(to right, #CD2A3E 33.3%, #F4F5F0 33.3%, #F4F5F0 66.6%, #008C45 66.6%);
                    border-radius: 5px;
                }
                .content b, .content strong { font-weight: bold; }
                .content i, .content em { font-style: italic; }
                .content u { text-decoration: underline; }
                .content div[style*="text-align: center"] { text-align: center; }
                .content div[style*="text-align: right"] { text-align: right; }
                .content div[style*="text-align: justify"] { text-align: justify; }
                /* List formatting */
                .content ul, .content ol { margin-left: 1.5em; margin-bottom: 1em; line-height: 1.5; }
                .content ul ul, .content ol ol { margin-left: 1.5em; } /* For nested lists */
                .content li { margin-bottom: 0.5em; }
                .content font[color] { color: inherit; } .content font[face] { font-family: inherit; }
                .content font[size="1"] { font-size: x-small; } .content font[size="2"] { font-size: small; }
                .content font[size="3"] { font-size: medium; } .content font[size="4"] { font-size: large; }
                .content font[size="5"] { font-size: x-large; } .content font[size="6"] { font-size: xx-large; }
                .content font[size="7"] { font-size: xxx-large; }
                .preview-context-menu {
                    position: absolute; z-index: 10000; background-color: #ffffff;
                    border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    border-radius: 6px; padding: 5px 0; display: none;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    font-size: 11pt; min-width: 180px;
                }
                .preview-context-menu ul { list-style: none; padding: 0; margin: 0; }
                .preview-context-menu ul li {
                    padding: 9px 15px; cursor: pointer; display: flex; align-items: center; color: #333;
                }
                .preview-context-menu ul li:hover { background-color: #f0f2f5; }
                .preview-context-menu ul li svg {
                    margin-right: 12px; width: 16px; height: 16px;
                }
            </style>
            `;
            
            let body = `<div class="preview-container">`;
            const frontCoverImgSrc = document.getElementById('frontCoverPreview').src;
            if (frontCoverImgSrc && !frontCoverImgSrc.endsWith('#')) {
                const bookNumber = document.getElementById('bookNumber').value;
                body += `<div class="page cover-page-preview"><img src="${frontCoverImgSrc}" alt="Front Cover">${bookNumber ? `<div class="book-number-preview">${bookNumber}</div>` : ''}</div>`;
            }

            const allSectionPages = [];
            SECTION_ORDER.forEach(lang => {
                const sectionEl = document.getElementById(`${lang}-section`);
                const header = sectionEl.querySelector('.header-input').value;
                const footerText = sectionEl.querySelector('.section-footer-input').value;
                sectionEl.querySelectorAll('.page-wrapper').forEach(page => {
                    const pageType = page.dataset.pageType;
                    const pageNumSpan = page.querySelector('.page-number');
                    const pageNumContainer = page.querySelector('.page-number-container');
                    const isPageNumVisible = pageNumSpan && !pageNumContainer.classList.contains('hidden');
                    
                    let pageContentPresent = false; // Flag to track if the page has any content
                    let currentEditorContent = ''; // To hold modified editor HTML for text pages

                    if (pageType === 'design') {
                        const imgSrc = page.querySelector('.design-preview-img')?.src;
                        if (imgSrc && !imgSrc.endsWith('#')) {
                            pageContentPresent = true;
                        }
                    } else { // type === 'text'
                        const title = page.querySelector('.main-title').value;
                        const subtitle = page.querySelector('.subtitle').value;
                        const editor = page.querySelector('.master-text-editor');
                        let editorRawContent = editor.innerHTML.trim();

                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = editorRawContent;
                        tempDiv.querySelectorAll('.image-with-caption').forEach(figure => {
                            const resizableContainer = figure.querySelector('.resizable-image-container');
                            if (resizableContainer) {
                                figure.style.width = resizableContainer.style.width || 'auto';
                                figure.style.height = resizableContainer.style.height || 'auto';
                                resizableContainer.style.resize = 'none';
                                resizableContainer.style.overflow = 'hidden';
                                resizableContainer.style.border = 'none';
                                resizableContainer.style.cursor = 'default';
                            }
                        });
                        currentEditorContent = tempDiv.innerHTML;

                        // Check for meaningful text content (not just empty tags or whitespace)
                        const hasMeaningfulEditorContent = currentEditorContent.replace(/<[^>]+>/g, '').trim().length > 0 || hasVisualElements(tempDiv);
                        
                        // A page is considered "not blank" if it has a title, subtitle, editor content,
                        // a header, a footer, or a visible page number.
                        if (title.trim() !== '' || subtitle.trim() !== '' || hasMeaningfulEditorContent || header.trim() !== '' || footerText.trim() !== '' || isPageNumVisible) {
                            pageContentPresent = true;
                        }
                    }

                    if (pageContentPresent) { // Only add page to preview if content is present
                        if (pageType === 'design') {
                            const imgSrc = page.querySelector('.design-preview-img')?.src;
                            allSectionPages.push({ type: 'design', imgSrc: imgSrc });
                        } else { // type === 'text'
                            const title = page.querySelector('.main-title').value;
                            const subtitle = page.querySelector('.subtitle').value;
                            allSectionPages.push({
                                type: 'text',
                                header: header,
                                footerText: footerText,
                                title: title,
                                subtitle: subtitle,
                                editorContent: currentEditorContent,
                                pageNumber: isPageNumVisible ? pageNumSpan.textContent : null
                            });
                        }
                    }
                });
            });

            // Render only visible pages
            allSectionPages.forEach(pageData => {
                if (pageData.type === 'design') {
                    body += `<div class="page design-page-preview"><img src="${pageData.imgSrc}" alt="Design Page"></div>`;
                } else {
                    body += `<div class="page">`;
                    body += `<div class="header">${pageData.header || ''}</div>`;
                    body += `<div class="content">`;
                    if (pageData.title) body += `<div class="main-title-container-preview"><h1>${pageData.title}</h1></div>`;
                    if (pageData.subtitle) body += `<div class="subtitle-wrapper"><h2>${pageData.subtitle}</h2></div>`;
                    body += pageData.editorContent;
                    body += `</div>`;
                    body += `<div class="footer">`;
                    if (pageData.footerText) {
                        body += `<div class="footer-text-container-preview">${pageData.footerText}</div>`;
                    } else {
                        body += `<div></div>`; 
                    }
                    if (pageData.pageNumber) {
                        body += `<div class="page-number-container-preview">${pageData.pageNumber}</div>`;
                    }
                    body += `</div>`;
                    body += `</div>`;
                }
            });


            const backCoverImgSrc = document.getElementById('backCoverPreview').src;
            if (backCoverImgSrc && !backCoverImgSrc.endsWith('#')) {
                body += `<div class="page cover-page-preview"><img src="${backCoverImgSrc}" alt="Back Cover"></div>`;
            }
            body += `</div>`;

            const contextMenuHTML = `
                <div id="preview-context-menu" class="preview-context-menu">
                    <ul>
                        <li id="save-pdf-option">
                            <svg fill="#c0392b" viewBox="0 0 384 512"><path d="M64 0C28.7 0 0 28.7 
